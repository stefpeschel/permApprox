% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/dot_compute_pvals_gpd.R
\name{.compute_pvals_gpd}
\alias{.compute_pvals_gpd}
\title{Compute p-values via GPD tail approximation (constrained or unconstrained)}
\usage{
.compute_pvals_gpd(
  obs_stats,
  perm_stats,
  idx_fit,
  control,
  cores,
  parallel_min,
  verbose,
  ...
)
}
\arguments{
\item{obs_stats}{Numeric vector of observed test statistics
(\code{length = n_test}).}

\item{perm_stats}{Numeric matrix of permutation statistics with dimension
\code{B x n_test}.  
If \code{control$include_obs = TRUE}, the vector \code{obs_stats} is
appended as an additional row prior to threshold detection and fitting.}

\item{idx_fit}{Integer vector of test indices (subset of
\code{1:length(obs_stats)}) for which GPD approximation should be
attempted. Typically defined in \code{\link{compute_p_values}} as
those tests with empirical p-values below \code{fit_thresh}.}

\item{control}{A control list created by \code{\link{make_gpd_ctrl}}.
It contains GPD fitting options, threshold detection settings,
constraint mode, epsilon function (\code{eps_fun}),
epsilon tuning parameter (\code{eps_tune}),
optional epsilon arguments (\code{eps_args}),
and zero-guard configuration.}

\item{cores}{Integer >= 1. Number of CPU cores for parallel computations.
Default: 1.}

\item{parallel_min}{Integer. Minimum number of tests in a given
computation step (e.g., threshold detection, GPD/Gamma fitting, epsilon
refinement) for which parallel computation is used when \code{cores > 1}.
If the number of tests is smaller than \code{parallel_min}, the
corresponding step is run sequentially to avoid parallel overhead.
Default: \code{10}.}

\item{verbose}{Logical scalar. If \code{TRUE}, progress messages are printed.
Default: TRUE.}

\item{...}{Additional arguments passed downstream to internal fitting
functions such as \code{fit_gpd}.}
}
\value{
A named \code{list} with one element per output quantity. Except for
\code{perm_stats_fit}, each element is a vector of length \code{n_test}:
\describe{
  \item{\code{p_value}}{GPD-based tail p-values (or \code{NA_real_} if no
        valid GPD fit was obtained for a test). These are combined with
        empirical p-values in \code{\link{compute_p_values}}.}
  \item{\code{thresh}}{Selected GPD threshold (or \code{NA_real_} if none
        found).}
  \item{\code{n_exceed}}{Number of exceedances used for the GPD fit.}
  \item{\code{shape}}{Estimated GPD shape parameter (\code{NA_real_} if no
        fit was obtained).}
  \item{\code{scale}}{Estimated GPD scale parameter (\code{NA_real_} if no
        fit was obtained).}
  \item{\code{epsilon}}{Final epsilon used in the GPD fit (after refinement
        if zero-guard was active).}
  \item{\code{gof_p_value}}{Goodness-of-fit p-value (Anderson–Darling or
        Cramér–von Mises depending on \code{control$gof_test}).}
  \item{\code{status}}{Factor describing the per-test fitting outcome:
    \code{"not_selected"}, \code{"success"}, \code{"discrete"},
    \code{"no_threshold"}, \code{"gof_reject"}, \code{"fit_failed"}.}
  \item{\code{discrete}}{Logical flag indicating whether the permutation
        distribution was too discrete for reliable tail fitting.}
  \item{\code{perm_stats_fit}}{List of length \code{n_test} containing the
        exceedances used for each successful GPD fit (empty numeric vectors
        for tests not fitted or not successful).}
}
}
\description{
Internal workhorse for computing permutation p-values using the
Generalized Pareto Distribution (GPD) tail approximation.  
For each test, the function:
\enumerate{
  \item receives a set of tests selected for GPD fitting (indices in
        \code{idx_fit}, typically based on empirical p-values below a
        threshold in the calling function),
  \item performs discreteness screening,
  \item detects a GPD threshold using \code{\link{.find_gpd_thresh}},
  \item evaluates the appropriate support boundary
        (depending on the constraint in \code{control}),
  \item computes \eqn{\varepsilon}-values via the epsilon function
        defined in \code{control} (\code{eps_fun}, \code{eps_tune},
        \code{eps_args}),
  \item fits the GPD tail using \code{\link{fit_gpd}},
  \item optionally performs adaptive epsilon refinement
        (zero-guard) to avoid numerical underflow, and
  \item returns GPD-based p-values and diagnostics.
}

The function supports parallel execution for threshold detection and
GPD fitting through the \pkg{future} framework.
}
\keyword{internal}
