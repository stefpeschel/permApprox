% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/compute_p_values.R
\name{compute_p_values}
\alias{compute_p_values}
\title{Compute empirical and approximated p-values from permutation tests}
\usage{
compute_p_values(
  obs_stats,
  perm_stats,
  method = "gpd",
  fit_thresh = 0.2,
  alternative = "two_sided",
  null_center = 0,
  adjust_method = "BH",
  gpd_ctrl = make_gpd_ctrl(),
  gamma_ctrl = make_gamma_ctrl(),
  adjust_ctrl = make_adjust_ctrl(),
  ...
)
}
\arguments{
\item{obs_stats}{Numeric vector of observed test statistic(s).}

\item{perm_stats}{Permutation test statistics. Should be provided as a 
numeric matrix or data frame with permutations in rows and tests in 
columns.}

\item{method}{Character. Method used to compute p-values. Default is
\code{"gpd"}. Options are:
\itemize{
  \item \code{"empirical"}: Empirical p-values are returned directly,
  based on the number of permutation test statistics that are as or
  more extreme than the observed statistic.
  \item \code{"gamma"}: A Gamma distribution is fitted to the permutation
    distribution if the empirical p-value falls below \code{fit_thresh}.
  \item \code{"gpd"}: A Generalized Pareto Distribution (GPD) is fitted
    to the tail of the permutation distribution if the empirical p-value
    falls below \code{fit_thresh}.
}}

\item{fit_thresh}{Numeric. Threshold on empirical p-values below which
parametric fitting is applied. Default: \code{0.2} (parametric
approximation if the empirical p-value is smaller than 0.2).}

\item{alternative}{Character. One of \code{"greater"}, \code{"less"}, or
\code{"two_sided"} (default), indicating the tail of the test.}

\item{null_center}{Numeric or character. Specifies the value around which the
null distribution is centered. If set to \code{"mean"} or \code{"median"},
the per-row mean or median of \code{perm_stats} is used instead.
This allows testing against a null hypothesis other than zero or centering
based on the empirical distribution.}

\item{adjust_method}{Character. Method for multiple testing adjustment.
Options include:
\itemize{
  \item \code{"none"}: No adjustment.
  \item \code{"lfdr"}: Local false discovery rates via \code{fdrtool}.
  \item \code{"adaptBH"}: Adaptive Benjamini-Hochberg (requires estimation
  of the proportion of true nulls).
  \item Any method supported by \code{stats::p.adjust} (e.g., "holm", "BH",
  "BY").
}}

\item{gpd_ctrl}{A control object created by \code{\link{make_gpd_ctrl}}.
Contains settings for the GPD approximation, such as the fitting method,
constraints, and thresholding strategy. Defaults to \code{make_gpd_ctrl()}.}

\item{gamma_ctrl}{A control object created by \code{\link{make_gamma_ctrl}}.
Contains settings for the Gamma approximation, including goodness-of-fit
test and inclusion of the observed statistic. Defaults to
\code{make_gamma_ctrl()}.}

\item{adjust_ctrl}{A control object created by \code{\link{make_adjust_ctrl}}.
Contains settings for multiple testing correction, such as the adjustment
method and estimation of the proportion of true null hypotheses.
Defaults to \code{make_adjust_ctrl()}.}

\item{...}{Additional arguments (currently unused).}
}
\value{
A list containing:
\describe{
  \item{p_values}{Numeric vector of approximated p-values. These are either
  unadjusted or adjusted for multiple testing, depending on the chosen
  adjustment method in the \code{control$adjust} settings.}
  \item{p_unadjusted}{Numeric vector of approximated but unadjusted p-values.}
  \item{p_empirical}{Numeric vector of raw empirical p-values.}
  \item{gpd_fit}{Details of GPD fit (if used), or \code{NULL}.}
  \item{gamma_fit}{Details of Gamma fit (if used), or \code{NULL}.}
  \item{method_used}{Character. Method used per test.}
  \item{adjust_result}{Full output of \code{mult_adjust()} if adjustment used.}
  \item{control}{List with the used control arguments.}
}
}
\description{
Computes empirical p-values for permutation tests.
When p-values are small, a Gamma or Generalized Pareto Distribution
(GPD) is fitted to the (tail of the) permutation distribution to improve
resolution if the number of permutations is small.
}
\details{
The function always computes empirical p-values for each test statistic by
comparing the observed statistic to the permutation distribution.
Specifically, the empirical p-value is calculated as
\deqn{p = \frac{r + 1}{B + 1}}
where \eqn{r} is the number of permutation statistics that are as or more
extreme than the observed statistic (according to the specified alternative),
and \eqn{B} is the number of permutations. This correction ensures that no
p-value is exactly zero.

If \code{method} is set to \code{"gpd"} or \code{"gamma"}, a
parametric distribution is fitted to (the tail of) the permutation
distribution for cases where the empirical p-value falls below the threshold
specified by \code{fit_thresh}.
In such cases, the returned \code{p_values} vector contains the approximated
values (empirical for larger p-values, approximated for smaller ones).

If \code{method = "none"}, only empirical p-values are returned.
}
\examples{
# Generate observed and permuted test statistics
set.seed(12345)
obs <- c(2.0, 3.0, 4.0, 5.0)
perm <- matrix(rnorm(4000), nrow = 4)

# Empirical p-values
res_emp <- compute_p_values(obs_stats = obs,
                            perm_stats = perm,
                            method = "empirical")

# Gamma approximation
gamma_ctrl <- make_gamma_ctrl(gof_test = "none")
res_gamma <- compute_p_values(obs_stats = obs,
                              perm_stats = perm,
                              method = "gamma",
                              gamma_ctrl = gamma_ctrl)

# GPD approximation without constraint
gpd_ctrl <- make_gpd_ctrl(constraint = "unconstrained")
res_gpd <- compute_p_values(obs_stats = obs,
                            perm_stats = perm,
                            method = "gpd")

# GPD approximation with constraint
gpd_ctrl <- make_gpd_ctrl(constraint = "support_at_obs")

res_gpd_constr <- compute_p_values(obs_stats = obs,
                                   perm_stats = perm,
                                   method = "gpd",
                                   gpd_ctrl = gpd_ctrl)

# GPD approximation with constraint and fixed epsilon
gpd_ctrl <- make_gpd_ctrl(constraint = "support_at_max",
                          eps_fun = eps_fixed, 
                          eps_par = list(value = 0.1))

res_gpd_constr_eps0.1 <- compute_p_values(obs_stats = obs,
                                   perm_stats = perm,
                                   method = "gpd",
                                   gpd_ctrl = gpd_ctrl)

# Data frame with (unadjusted) p-values
p_values <- data.frame(empirical = res_emp$p_unadjusted,
                       gamma = res_gamma$p_unadjusted,
                       gpd = res_gpd$p_unadjusted,
                       gpd_constr = res_gpd_constr$p_unadjusted,
                       gpd_constr_eps0.1 = res_gpd_constr_eps0.1$p_unadjusted)

p_values

}
